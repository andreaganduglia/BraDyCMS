<div id="{{ uid }}">
  <h1>{{ tr.get('manage_articles') }}</h1>

	<div class="btn-group" style="padding:20px 0;">
		<a class="btn btn-info" href="#article/addNew" title="{{ tr.get('add_new_article') }}"><i class="glyphicon glyphicon-plus"></i> {{ tr.get('add_new_article') }}</a>
		<a class="btn btn-default reload" title="{{ tr.get('reload') }}"><i class="glyphicon glyphicon-repeat"></i> {{ tr.get('reload') }}</a>
	</div>
	
	<div class="row well">
    <label class="col-md-1"><i class="glyphicon glyphicon-tag" style="font-size:3em;"></i></label>
    <div class="col-md-9">
      <input type="text" name="tags" value="{{ active_tags|join(',') }}" class="tags" style="width:100%" />
    </div>
    <div class="col-md-2">
      <button class="btn btn-success btn-block filter">{{ tr.get('apply_filter') }} <i class="glyphicon glyphicon-filter"></i></button>
    </div>
  </div>

  <div class="well well-sm clearfix delete-tag-container" style="margin: 10px 0 20px 0; display: none;">
    <span class="text-danger">
      <i style="font-size:1.5em;" class="glyphicon glyphicon-exclamation-sign"></i> 
      {{ tr.sget('confirm_delete_tag_not_used', active_tags[0]) }}</span> 
      <button class="btn btn-danger deleteTag"><i class="glyphicon glyphicon-trash"></i> {{ tr.get('delete') }}</button>
      <button class="btn btn-danger deleteAllTags"><i class="glyphicon glyphicon-fire"></i> {{ tr.get('delete_unused_tags') }}</button>
  </div>
	




	<table class="table table-striped table-bordered table-hover data_table table-responsive">
		<thead>
			<tr>
				<th>{{ tr.get('id') }}</th>
				<th>{{ tr.get('title') }}</th>
				<th>{{ tr.get('textid') }}</th>
        <th>{{ tr.get('sorting') }}</th>
        <th>{{ tr.get('author') }}</th>
        <th>{{ tr.get('status') }}</th>
        <th>{{ tr.get('publish') }}</th>
        <th style="min-width:150px;"></th>
			</tr>
		</thead>

		<tbody>
		</tbody>

	</table>
</div>
<script>
$('#{{ uid }} a.reload').click(function(){
	admin.tabs.reloadActive();
	return false;
});

var tb = $('#{{ uid }} table.data_table').dataTable({
	"iDisplayLength": 10,
	"bDestroy": true,
  "bProcessing": true,
  "bServerSide": true,
  "sAjaxSource": "./controller.php?obj=article_ctrl&method=sql2json{{ imploded_active_tags|raw }}",
  "aoColumns": [
    {"mData":"id"},
    {
      "mData": function(row){
        return '<a href="#article/edit/' + row.id + '">' + row.title + '</a>'
      }
    },
    {"mData":"textid"},
    {"mData":"sort"},
    {"mData":"author"},
    {"mData":"status"},
    {"mData":"publish"},
    {
      "mData":  function(row){
        return '<div class="btn-group">'
          + '<a href="#article/edit/' + row.id +'" class="btn btn-default btn-sm" title="{{ tr.get('edit') }}"><i class="glyphicon glyphicon-edit"></i></a>'
          
						{% for lang in cfg_langs %}
							+ ' <a href="#article/translate/{{ lang.id }}/{{ art.id }}" class="btn btn-default btn-sm" title="{{ tr.get('translate_article_in', lang.string) }}"><i class="glyphicon glyphicon-random text-muted"></i> {{ lang.id|upper }}</a>'
						{% endfor %}
          + '<a href="#" class="btn btn-default delete_article btn-sm" data-id="'+ row.id +'" title="{{ tr.get('delete') }}"><i class="glyphicon glyphicon-trash"></i></a>'
          + '</div>'
      }
    }
  ],
  "fnDrawCallback": function(){
  
    // Show delete tags button
    {% if active_tags|length == 1 and active_tags[0] != '' %}
    if (this.fnSettings().fnRecordsDisplay() === 0){
      
      $('#{{ uid }} .delete-tag-container').show();
    }
    {% endif %}
  
  
    $('#{{ uid }} a.delete_article').click(function(event){
      event.preventDefault();
      var $this = $(this);
      admin.dialog({
        title: '{{ tr.get('pay_attention_please') }}',
        html: '{{ tr.get('confirm_delete_article') }}',
        buttons: [
                  {
                    text: '<i class="glyphicon glyphicon-trash"></i> {{ tr.get('delete') }}',
                    addclass: 'btn-danger',
                    action: 'close',
                    click: function(){
                      $.get('controller.php?obj=article_ctrl&method=delete&param[]=' + $this.data('id'), function(data){
                        admin.message(data.text, data.type);
                        if (data.type === 'success'){
                          admin.tabs.reloadActive();
                        }
                      }, 'json')
                    }
                  },
                  {
                    text: '{{ tr.get('close') }}',
                    action: 'close'
                  }
                 ]
      });
    });
  
  }
});



$('#{{ uid }} .deleteTag').on('click', function(){

  $.get('controller.php?obj=article_ctrl&method=deleteTag&tag={{ active_tags[0] }}', function(data){
    if (!data){
      admin.tabs.closeActive('article/all');
    } else {
      admin.message(data, 'error');
    }
  });
});
	
	
$('#{{ uid }} .deleteAllTags').on('click', function(){
  $.get('controller.php?obj=article_ctrl&method=deleteAllTags', function(data){
    if (!data){
      admin.tabs.closeActive('article/all');
    } else {
      admin.message(data, 'error');
    }
  });
});


$('#{{ uid }} input.tags').select2({
  tags: [{{ imploded_tags|raw }}]

});

$('#{{ uid }} .filter').on('click', function(){
  var used = $('#{{ uid }} input.tags').val();

  admin.tabs.closeActive('article/all' + (used.length ? '/' + used.replace(',', '/') : ''));
});
</script>

